name: Code Quality Check

on:
  push:
    # 1. CORRECTION: Fusion des branches en une seule liste valide
    branches: [ main, feature/LDARDAOO, feature/donald-revision-code ]
  pull_request:
    branches: [ main ] # Gardons 'main' pour les PR

jobs:
  quality-check:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: read
      
    steps:
    
    # 1. AJOUT du Checkout du code pour accéder à requirements.txt
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check Conventional Commits
      uses: webiny/action-conventional-commits@v1.3.0
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Condition pour la robustesse (MEILLEUR)
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        else
          echo "No requirements.txt found, skipping dependencies installation"
        fi
    
    - name: Run type checking with mypy
      run: |
        if command -v mypy &> /dev/null; then
          mypy . --ignore-missing-imports --no-strict-optional || echo "MYPY_FAILED=true" >> $GITHUB_ENV
        else
          echo "mypy not installed, skipping type checking"
        fi
      continue-on-error: true
    
    - name: Run linting with ruff
      run: |
        if command -v ruff &> /dev/null; then
          ruff check . --output-format=json > ruff-report.json || echo "RUFF_FAILED=true" >> $GITHUB_ENV
        else
          echo "ruff not installed, skipping linting"
        fi
      continue-on-error: true
    
    - name: Run tests with pytest
      run: |
        if [ -d tests/ ] && command -v pytest &> /dev/null; then
          pytest tests/ -v --tb=short || echo "PYTEST_FAILED=true" >> $GITHUB_ENV
        else
          echo "pytest not installed or tests/ directory not found, skipping tests"
        fi
      continue-on-error: true
    
    - name: AI Code Review
      env:
        GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      run: |
        if [ -f .github/scripts/ai_code_review.py ]; then
          python .github/scripts/ai_code_review.py || echo "AI_REVIEW_FAILED=true" >> $GITHUB_ENV
        else
          echo "AI code review script not found, skipping"
        fi
      continue-on-error: true
    
    # 2. & 3. CORRECTIONS: Alignement sur les secrets LDARDAO et Débogage
    - name: Check results and send email
      env:
        EMAIL_USERNAME: ${{ secrets.EMAIL_LDARDAO }}
        EMAIL_PASSWORD: ${{ secrets.PASSWORD_LDARDAO }}
        TEAM_EMAIL: ${{ secrets.TEAM_EMAIL }}
      run: |
        # DÉBOGAGE: Vérifie si les secrets sont vides
        echo "Vérification des variables d'email..."
        if [ -z "$EMAIL_USERNAME" ]; then
          echo "ERREUR CRITIQUE: Le secret EMAIL_LDARDAO n'est pas rempli ou accessible."
          echo "Veuillez vérifier et RENSEIGNER sa valeur sur GitHub."
          exit 1 
        fi
        if [ -z "$EMAIL_PASSWORD" ]; then
          echo "ERREUR CRITIQUE: Le secret PASSWORD_LDARDAO n'est pas rempli ou accessible."
          echo "Veuillez vérifier et RENSEIGNER sa valeur sur GitHub."
          exit 1 
        fi
        echo "Les secrets sont présents. Tentative d'exécution du script..."

        # Exécution du script principal
        if [ -f .github/scripts/check_results.py ]; then
          python .github/scripts/check_results.py
        else
          echo "Check results script not found, skipping"
        fi
    
    - name: Upload reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: quality-reports
        path: |
          ruff-report.json
          ai-review-report.txt
          mypy-report.txt
        if-no-files-found: ignore
        
# LA SECTION DUPLIQUÉE DES STEPS A ÉTÉ SUPPRIMÉE ICI (FIN DU FICHIER)